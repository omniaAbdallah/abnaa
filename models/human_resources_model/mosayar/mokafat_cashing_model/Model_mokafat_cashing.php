<?phpclass Model_mokafat_cashing extends CI_Model{    public function __construct()    {        parent:: __construct();    }    public function chek_Null($post_value)    {        if ($post_value == '' || $post_value == null || (!isset($post_value))) {            $val = '';            return $val;        } else {            return $post_value;        }    }    public function get_EmployeeData($arr)    {        $this->db->select('employee,emp_code,card_num');        $this->db->from('employees');        $this->db->where('employee_type',1);        $this->db->where($arr);        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->row();        } else {            return false;        }    }    public function get_mokafat_type(){        $this->db->select('*');        $this->db->from('hr_mokafat_types');        $this->db->order_by('id','asc');        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->result();        } else {            return false;        }    }    public function SelectEmployeeDataByarr($arr)    {        $this->db->select('*');        $this->db->from('employees');                 if ($arr != ' ') {            $this->db->where($arr);        }        $this->db->where('employee_type',1);        $this->db->order_by('emp_code') ;        $query = $this->db->get();        if ($query->num_rows() > 0) {            $x = 0;            foreach ($query->result() as $row) {                $data[$x] = $row;                $data[$x]->nationality = $this->get_from_employee_setting($row->nationality);               // $data[$x]->banks = $this->get_approved_banks(array('emp_code'=>$row->id));                $x++;            }            return $data;        } else {            return false;        }    }    public function get_from_employee_setting($id)    {        $this->db->select('title_setting');        $this->db->from('employees_settings');        $this->db->where('id_setting',$id);        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->row()->title_setting;        }else{            return 0;        }    }    public function check_emp($emp_code)    {        $this->db->select('emp_code');        $this->db->from("employees");         $this->db->where('employee_type',1);        $this->db->where("emp_code", $emp_code);        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->num_rows();        } else {            return 0;        }    }    public function select_last_value_fild()    {        $this->db->select('mokafa_rkm');        $this->db->from('hr_mokafat');        $this->db->order_by("mokafa_rkm", "DESC");        $this->db->limit(1);        $query = $this->db->get();        if ($query->num_rows() > 0) {            foreach ($query->result() as $row) {                $data = $row->mokafa_rkm;            }            return $data;        }        return 0;    }    //==========================================     public function insert()    {                    $data['month'] = $this->get_month( $data['mokafa_date_ar']);    $data['year'] = date('Y', $data['mokafa_date']);        //$data['mokafa_rkm'] = $this->input->post('mokafa_rkm');		 $data['mokafa_rkm'] = $this->select_last_value_fild()+1;        $data['mon_melady'] = $this->input->post('mon_melady');        $data['mokafa_date'] = strtotime($this->input->post('mokafa_date'));        $data['mokafa_date_ar'] = $this->input->post('mokafa_date');        $data['month'] = date('m',$data['mokafa_date']);        $data['year'] = date('Y',$data['mokafa_date']);        $mokafa_value_type=0;        $data['mokafa_value_type'] = $mokafa_value_type;        //$data['mokafa_value_type'] = $this->input->post('mokafa_value_type');        $data['mokafa_type'] = $this->input->post('mokafa_type');        $data['total_value'] = $this->input->post('total_value');        $data['about'] = $this->chek_Null($this->input->post('about'));        $data['presence_number'] = $this->chek_Null(count($this->input->post('value')));        $data['publisher'] = $_SESSION["user_id"];        $this->db->insert('hr_mokafat', $data);        $this->insert_details($data['mokafa_rkm']);    }    public function UPDATE_mokafa($mokafa_rkm){        if(!empty($mokafa_rkm)) {            $this->db->where('mokafa_rkm', $mokafa_rkm);            $this->db->delete('hr_mokafat');            $this->db->where('mokafa_rkm_fk', $mokafa_rkm);            $this->db->delete('hr_mokafat_details');        }    $data['month'] = $this->get_month( $data['mokafa_date_ar']);    $data['year'] = date('Y', $data['mokafa_date']);                $data['mokafa_rkm'] = $mokafa_rkm;        $data['mon_melady'] = $this->input->post('mon_melady');        $data['mokafa_date'] = strtotime($this->input->post('mokafa_date'));        $data['mokafa_date_ar'] = $this->input->post('mokafa_date');        $data['month'] = date('m',$data['mokafa_date']);        $data['year'] = date('Y',$data['mokafa_date']);        $mokafa_value_type=0;        $data['mokafa_value_type'] = $mokafa_value_type;        //$data['mokafa_value_type'] = $this->input->post('mokafa_value_type');        $data['mokafa_type'] = $this->input->post('mokafa_type');        $data['total_value'] = $this->input->post('total_value');        $data['about'] = $this->chek_Null($this->input->post('about'));        $data['presence_number'] = $this->chek_Null(count($this->input->post('value')));        $data['publisher'] = $_SESSION["user_id"];        /* echo'<pre>';                  print_r($_POST);                  echo '</pre>';                  die;*/        $this->db->insert('hr_mokafat', $data);        $this->insert_details($data['mokafa_rkm']);    }            //==========================================    public function check_mokafa_months($year){        $query = $this->db->select('month')->where('year',$year)->get('hr_mosayar_total')->result();        if (!empty($query)) {            $data = array();            foreach ($query as $row) {                array_push($data, $row->month);            }            return $data;        } else{            return array();        }    }    //========================================== public function insert_details($mokafa_rkm_fk)    {        $main = $this->input->post('value');        $bank_code = $this->input->post('bank_code');        $bank_name = $this->input->post('bank_name');        $bank_account_num = $this->input->post('bank_account_num');        $card_num = $this->input->post('card_num');        $name = $this->input->post('name');        $mosma_wazefy_n = $this->input->post('mosma_wazefy_n');        $edara_n = $this->input->post('edara_n');        $qsm_n = $this->input->post('qsm_n');        $mokafa_types = $this->input->post('mokafa_types');        $mokafa_option = $this->input->post('mokafa_option');        $data["mokafa_rkm_fk"] = $mokafa_rkm_fk;         $data["mokafa_rkm_fk"] = $mokafa_rkm_fk;         $data['month'] = $this->get_month( $this->input->post('mokafa_date'));         $data['year'] = date('Y',strtotime($this->input->post('mokafa_date')));                foreach ($main as $item => $value) {                                   $data['emp_code'] = $this->chek_Null($item);            $data['value'] = $this->chek_Null($value);            $data['bank_account_num'] = $this->chek_Null($bank_account_num[$item]);            $data['bank_code'] = $this->chek_Null($bank_code[$item]);            $data['bank_responsible_national_num'] = $this->chek_Null($card_num[$item]);            $data['bank_responsible_name'] = $this->chek_Null($name[$item]);            $data['day'] = date('d',strtotime($this->input->post('mokafa_date')));            $data['mosma_wazefy_n'] = $this->chek_Null($mosma_wazefy_n[$item]);            $data['qsm_n'] = $this->chek_Null($qsm_n[$item]);            $data['edara_n'] = $this->chek_Null($edara_n[$item]);            $data["mokafa_types"] = $mokafa_types[$item];            $data["mokafa_option"] = $mokafa_option[$item];            $this->db->insert("hr_mokafat_details", $data);        }    }    public function select_all_banks()    {        $this->db->select('id ,title');        $this->db->from("banks_settings");        $this->db->order_by("id", "DESC");        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->result();        }        return false;    }    //==========================================    public function select_all()    {        $this->db->select('*');        $this->db->from('hr_mokafat');       // $this->db->join('bnod_help', 'bnod_help.id = hr_mokafat.bnod_help_fk', "left");        //$this->db->group_by("sarf_num");        $this->db->order_by("id", "DESC");        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->result();        }        return false;    }    	    public function select_all_sarf_detalis($sarf_num_fk){        $this->db->select('hr_mokafat_details.*,        employees.emp_code,employees.nationality,        banks_settings.bank_code,banks_settings.title as bank_title');        $this->db->from('hr_mokafat_details');        $this->db->join('employees', 'employees.emp_code = hr_mokafat_details.emp_code', "left");        $this->db->join('banks_settings', 'banks_settings.bank_code = hr_mokafat_details.bank_code', "left");        $this->db->where("mokafa_rkm_fk", $sarf_num_fk);        $this->db->order_by("hr_mokafat_details.emp_code", "asc");        $query = $this->db->get();        if ($query->num_rows() > 0) {            $x = 0;            foreach ($query->result() as $row) {                $data[$x] = $row;                $data[$x]->nationality = $this->get_from_employee_setting($row->nationality);                $data[$x]->mokafa_types_title = $this->get_mokafa_types_title($row->mokafa_types);                $x++;            }            return $data;        }else{            return false;        }    }    public function getLastRecord()    {      //  $array = array('hr_mokafat.cashing_date>='=>strtotime(date("Y-m-d")),'hr_mokafat.approved'=>1);      $array = array('hr_mokafat.sarf_num>='=>10,'hr_mokafat.approved'=>1);        return $this->db->select('*')            ->where($array)            ->get('hr_mokafat')            ->row_array();    }    public function make_approve($id){        $data['approved']=1;        $data['cashing_date']=strtotime($this->input->post('cashing_date'));        $data['due_date']=strtotime($this->input->post('due_date'));        $this->db->where('id',$id);        $this->db->update('hr_mokafat',$data);    }   public function getSarf_data($sarf_num)    {        $h = $this->db->get_where("hr_mokafat", array('mokafa_rkm' => $sarf_num));        return $h->row_array();    }    //==========================================    //==================================================================    //======================   31-10-2018 =================    public function getBank_name($id)    {        $h = $this->db->get_where("banks_settings", array('id' => $id));        return $h->row_array()['ar_name'];    }    public function getBank_code($id)    {        $h = $this->db->get_where("banks_settings", array('id' => $id));        return $h->row_array()['bank_code'];    } public function cheetDetailes_emp($num){        $this->db->select('*');        $this->db->from("hr_mokafat_details");        $this->db->where("sarf_num_fk",$num);        return $this->db->get()->result();    }        public function getById_emp($num){        $h = $this->db->get_where("hr_mokafat", array('sarf_num'=>$num));        return $h->row_array();    }   public function getBand_help_name($bnod_help_fk){        $h = $this->db->get_where("bnod_help", array('id'=>$bnod_help_fk));        return $h->row_array()['short_title'];    }    public function select_main_data_sarf($id)    {        $this->db->select('hr_mokafat.* ,bnod_help.title as band_name');        $this->db->from('hr_mokafat');        $this->db->join('bnod_help', 'bnod_help.id = hr_mokafat.bnod_help_fk',"left");        $this->db->where("sarf_num",$id);        $query = $this->db->get();        if ($query->num_rows() > 0) {            $data =  $query->row() ;            $data->count_sarf_member = $this->count_sarf_member($data->sarf_num);            return $data;        }        return false;    }    public function count_sarf_member($sarf_num)    {        $this->db->select('*');        $this->db->from('hr_mokafat_details');        $this->db->where("sarf_num_fk",$sarf_num);        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->num_rows() ;        }        return 0;    }    public function select_from_main_data()    {        $this->db->select('*');        $this->db->from('main_data');        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->row() ;        }        return false;    }    public function delete_mokfaat($table,$arr){        $this->db->where($arr);        $this->db->delete($table);    }    public function get_some_emp()    {          $checkbox_value = $this->input->post('checkbox_value');          $arr = explode(',',$checkbox_value);            $this->db->where_in('emp_code', $arr);            $this->db->where('employee_type',1);        $this->db->order_by('emp_code') ;        $query = $this->db->get('employees');        if ($query->num_rows() > 0) {            $x = 0;            foreach ($query->result() as $row) {                $data[$x] = $row;                $data[$x]->nationality = $this->get_from_employee_setting($row->nationality);               // $data[$x]->banks = $this->get_approved_banks(array('emp_code'=>$row->id));                $x++;            }            return $data;        } else {            return false;        }    }    public function select_month_data()    {        $this->db->select('*');        $this->db->from('hr_mokafat');        $this->db->where('month',date('m'));        $this->db->where('year',date('Y'));        $query = $this->db->get();        if ($query->num_rows() > 0) {            foreach ( $query->result() as $row){              $data[] =  $row->mokafa_rkm;            }            return $data ;        }        return false;    }    public function select_month_data_by_day($day,$arr,$emp_code)    {        $this->db->select('*');        $this->db->from('hr_mokafat_details');        $this->db->where_in('mokafa_rkm_fk',$arr);        $this->db->where('day',$day);        $this->db->where('emp_code',$emp_code);        $query = $this->db->get();        if ($query->num_rows() > 0) {            $total =0;            foreach ( $query->result() as $row){                $total +=$row->value;            }            return $total ;        }        return false;    }    public function select_mokafat_data()    {     $mokafat_num_arr =$this->select_month_data();     if(!empty($mokafat_num_arr)) {         $this->db->select('*');         $this->db->from('hr_mokafat_details');         $this->db->where_in('mokafa_rkm_fk', $mokafat_num_arr);         $this->db->group_by('emp_code');         $query = $this->db->get();         if ($query->num_rows() > 0) {             $x=1;             foreach ( $query->result() as $row){                 $data[$x] =  $row;                 $data[$x]->days =  $this->get_days($mokafat_num_arr,$row->emp_code);             $x++;}             return $data ;         }     }        return false;    }    public  function  get_days($mokafat_num_arr,$emp_code){        $days_arr = array();        for ($a = 1; $a < 19; $a++) {            $days_arr[] = $a;        }        array_unshift($days_arr, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31);  if(!empty($days_arr)){      foreach ($days_arr as $row){          $arr[$row]=$this->select_month_data_by_day($row,$mokafat_num_arr,$emp_code);      }      return $arr;    }    }    public function get_mokafa_types_title($id)    {        $this->db->select('*');        $this->db->from('hr_mokafat_types');        $this->db->where('id',$id);        $query = $this->db->get();        if ($query->num_rows() > 0) {            return $query->row()->title ;        }        return false;    }                    function get_month($date = false){    if (empty($date)) {        $date = date('Y-m-d');    }    $date = '2020-' . date('m', strtotime($date)) . '-' . date('d', strtotime($date));    return $this->db->where('from_date <=', strtotime($date))->where('to_date >=', strtotime($date))->get('hr_mosayer_months')->row_array()['month'];}}//END CLASS